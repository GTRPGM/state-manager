# plan_0005 - GM Context Graph Relation Integration

## User Requirements

- GM 클라이언트가 세션의 전체 상태를 조회할 때, 엔티티(노드) 정보뿐만 아니라 그래프 상의 관계(Edge) 정보도 함께 받아야 함.
- 특히 `(Player)-[INVENTORY]->(Item)`, `(NPC)-[KNOWS/HATES]->(Player)` 등의 관계가 포함되어야 시각화 가능.

## Goal

- `StateService.get_state_snapshot` 및 하위 리포지토리 로직을 확장하여, 세션 컨텍스트 조회 시 관계(Relation) 데이터를 포함시킨다.

## Scope

- **In**:
  - `StateService.get_state_snapshot` 수정
  - `CypherEngine`을 통한 통합 관계 조회 쿼리 구현 (`MATCH (n)-[r]->(m) WHERE n.session_id = ...`)
  - API 응답 모델(`SessionContext` 등)에 `relations` 필드 추가
- **Out**:
  - 관계 데이터의 수정/삭제 (이는 plan_0006에서 처리)
  - 대량 노드에 대한 페이징 처리 (현재는 전체 스냅샷 목표)

## Implementation Plan

- **Step 1: 관계 조회용 Cypher 쿼리 작성**
  - `src/state_db/Query/CYPHER/INQUIRY/get_session_relations.cypher` 작성.
  - 세션 내 활성(Active) 엔티티 간의 모든 관계 조회.
- **Step 2: Repository 메서드 추가**
  - `EntityRepository` 또는 `SessionRepository`에 `get_all_relations(session_id)` 추가.
- **Step 3: Service 계층 통합**
  - `StateService.get_state_snapshot`에서 노드 조회와 병렬로(또는 순차로) 관계 데이터 조회 후 응답 객체에 병합.
- **Step 4: 응답 스키마 업데이트**
  - `WrappedResponse` 데이터 구조에 `relations` 리스트 추가.

## Unit Test Plan (must)

- **What to test**:
  - 세션에 관계가 존재할 때 `get_state_snapshot`이 올바른 Edge 리스트를 반환하는지.
  - 관계가 없을 때 빈 리스트를 반환하는지.
- **Test cases**:
  - `test_get_context_with_relations`: 더미 세션/관계 생성 후 조회 검증.
- **Command**:
  - `uv run pytest tests/test_logic_integration.py`

## E2E Plan (must)

- **Scenario**:
  - 세션 시작 -> NPC 스폰 -> 관계 생성(가정) -> `/session/{id}/context` 호출 -> 응답 내 `relations` 확인.
- **Expected**:
  - JSON 응답에 `nodes`와 함께 `relations` 필드가 존재하고, 생성한 관계가 포함됨.
- **How to run**:
  - `scripts/api_verification.py` (수정 필요할 수 있음) 또는 수동 `curl` 테스트.
- **Validation**:
  - 응답 JSON 구조 검증.

## Done Criteria

- [ ] `get_session_relations.cypher` 구현 완료
- [ ] `StateService`에서 관계 데이터 병합 로직 구현
- [ ] API 응답에 관계 데이터 포함 확인
- [ ] 유닛 테스트 통과
