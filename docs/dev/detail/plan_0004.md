# plan_0004 - Graph Sync Refinement & Test Suite Alignment

## User Requirements

- 테이블의 모든 속성을 그래프 노드로 동기화하려다 발생하는 에러 해결.
- 기존 테스트 코드 전수 조사 및 최신 스키마(관계 중심 그래프, 상태 중심 테이블)에 맞게 수정/삭제.

## Goal

- `sync_entity_to_graph` 트리거가 최소한의 식별 정보(ID, Session_id, Name, Active)만 동기화하도록 수정.
- `tests/` 디렉토리 내의 모든 테스트가 하이브리드 아키텍처 원칙에 부합하도록 정렬.

## Scope

- In: `src/state_db/Query/BASE/L_graph.sql`, `tests/` 전체
- Out: `src/state_db/Query/BASE/L_*.sql` (트리거 정의부)

## Implementation Plan

- Step 1: `L_graph.sql` 내의 `sync_entity_to_graph` 함수 수정 (속성 바인딩 시 `jsonb_build_object` 최소화).
- Step 2: 각 엔티티별 `L_<entity>.sql` 트리거 설정 확인 및 불필요한 속성 동기화 제거.
- Step 3: `tests/` 폴더 내 테스트 파일을 전수 조사하여 다음 기준에 따라 분류 및 조치:
  - 원칙 부합: 유지
  - 스키마 불일치: 수정 (예: 그래프에서 HP 조회하는 로직 삭제)
  - 레거시/불필요: 삭제
- Step 4: 수정된 환경에서 `scripts/verify_sql_syntax.py` 및 전체 테스트 실행.

## Unit Test Plan (must)

- What to test: 트리거 작동 후 그래프 노드에 불필요한 속성(state 등)이 없는지 확인.
- Test cases: `tests/test_graph_sync_triggers.py` (신규 또는 수정)
- Command:
  - uv run pytest tests/test_graph_sync_triggers.py

## E2E Plan (must)

- Scenario: 엔티티 생성 -> SQL 테이블 데이터 확인 -> 그래프 노드 속성 확인 (최소화 여부).
- Expected: 그래프 노드에는 `id`, `session_id`, `name`, `active`만 존재해야 함.
- How to run: `uv run python scripts/api_verification.py`
- Validation: DB 직접 조회를 통해 노드 프로퍼티 검증.

## Done Criteria

- [x] implementation completed
- [x] unit tests added/updated and passing
- [x] e2e executed and passing
- [x] docs updated if needed
