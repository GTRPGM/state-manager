# plan_0006 - Commit Router Relation Support

## User Requirements

- GM이 클라이언트에서 편집한 엔티티 관계(Edge) 변경 사항(관계 추가, 삭제, 속성 변경)을 `/commit` 엔드포인트를 통해 일괄 반영해야 함.
- 현재의 속성(Attribute) 변경 로직에 더해 관계(Relation) 변경 로직이 추가되어야 함.

## Goal

- `router_COMMIT.py` 및 `StateService`를 확장하여 `CommitRequest` 내의 관계 변경 사항을 처리하고 그래프 DB에 반영한다.

## Scope

- **In**:
  - `CommitRequest` 스키마 확장 (또는 기존 `diff` 구조 내 관계 표현 정의)
  - `StateService.write_state_changes` 내 관계 처리 로직 추가
  - Cypher 쿼리: `create_relation`, `delete_relation`, `update_relation_prop`
- **Out**:
  - 복잡한 트랜잭션 롤백 처리 (기본적인 에러 핸들링만 포함)
  - 대량 배치 처리 최적화 (기능 구현 우선)

## Implementation Plan

- **Step 1: Commit Request 스키마 분석 및 정의**
  - `diff` 필드 내에 관계 변경을 어떻게 표현할지 정의 (예: `{"rel_changes": [{"type": "ADD", "src": "...", "dest": "...", "label": "..."}]}`)
  - 필요하다면 Pydantic 모델 업데이트.
- **Step 2: 관계 조작 Cypher 쿼리 작성**
  - `src/state_db/Query/CYPHER/UPDATE/relation_create.cypher`
  - `src/state_db/Query/CYPHER/UPDATE/relation_delete.cypher`
- **Step 3: Service 로직 구현**
  - `StateService.write_state_changes`에서 `rel_changes` 파싱.
  - 각 변경 사항에 대해 적절한 Cypher 쿼리 실행.
- **Step 4: Router 통합**
  - `router_COMMIT.py`가 변경된 서비스 로직을 호출하도록 확인.

## Unit Test Plan (must)

- **What to test**:
  - `/commit` 요청으로 관계가 생성/삭제되는지.
  - 존재하지 않는 노드에 대한 관계 생성 시도 시 에러 처리.
- **Test cases**:
  - `test_commit_add_relation`: 두 노드 간 관계 생성 요청 -> 그래프 확인.
  - `test_commit_remove_relation`: 기존 관계 삭제 요청 -> 그래프 확인.
- **Command**:
  - `uv run pytest tests/test_router_COMMIT.py` (신규 생성 또는 업데이트)

## E2E Plan (must)

- **Scenario**:
  - 세션 로드 -> `/commit`으로 플레이어-NPC 간 'KNOWS' 관계 추가 -> `/session/{id}/context`로 관계 생성 확인.
- **Expected**:
  - Commit 성공(200 OK) 및 Context 조회 시 관계 포함.
- **How to run**:
  - `scripts/api_verification.py` 확장하여 관계 커밋 테스트 추가.
- **Validation**:
  - DB 상태 직접 조회 (Age Viewer 또는 `inspect_age.py`)

## Done Criteria

- [x] Request 스키마 확정
- [x] 관계 CRUD Cypher 쿼리 구현
- [x] `StateService` 관계 반영 로직 구현
- [x] 유닛 테스트 및 E2E 테스트 통과
