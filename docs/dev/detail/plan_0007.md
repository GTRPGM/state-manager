# plan_0007 - Rule Engine Player Lookup Endpoint Contract

## User Requirements

- Rule Engine이 사용할 플레이어 조회 엔드포인트 응답이 `player_info_schema.py` 형태를 만족해야 함.
- 내부 DB/도메인 모델은 그대로 두되, **엔드포인트 응답 계약(API contract)** 만 맞추면 됨.

## Goal

- `/state/player/{player_id}` 응답을 `player_info_schema.py`와 동일 계약으로 고정한다.
- `player.items`는 `ItemBase[]` 구조를 사용한다.

## Scope

- **In**:
  - `router_INQUIRY.py`의 player 조회 응답 계약 정합성 확보
  - `PlayerRepository.get_full_state` 응답 조립 로직 개선
  - 필요 시 전용 response DTO(호환 어댑터) 추가
- **Out**:
  - 내부 엔티티 스키마 전면 리팩터링
  - Rule Engine API 자체 변경

## Implementation Plan

- Step 1: `player_info_schema.py` 필드 기준으로 필수/옵션/기본값 매핑표 작성
- Step 2: `PlayerRepository.get_full_state`에서 `items`를 rule_id 리스트가 아닌 구조화된 아이템 객체로 구성
- Step 3: `player_npc_relations`의 `npc_id`, `npc_name`, `affinity_score` 직렬화 안전성(UUID/str) 보장
- Step 4: 엔드포인트 응답 모델을 기존 호환성 유지 범위에서 고정

## Unit Test Plan (must)

- **What to test**:
  - 플레이어 조회 응답이 `player_info_schema.py` 구조와 타입을 만족하는지
  - 아이템/관계가 비어있는 경우에도 스키마가 유지되는지
- **Test cases**:
  - `tests/test_router_INQUIRY.py::test_get_player_state` 확장
  - `tests/test_player_schema_contract.py` 신규 (contract test)
- **Command**:
  - `uv run pytest tests/test_router_INQUIRY.py tests/test_player_schema_contract.py`

## E2E Plan (must)

- **Scenario**:
  - 세션 시작 -> 플레이어 상태 조회 -> 응답 키/타입 검증
- **How to run**:
  - `scripts/api_verification.py`에 player contract assertion 추가

## Done Criteria

- [x] `/state/player/{player_id}` 응답이 `player_info_schema.py` 계약을 만족
- [x] 빈 데이터(아이템/관계 없음) 케이스 포함 검증 완료
- [x] 단위 테스트 + API 검증 스크립트 통과

## Fixed Decisions

- `items`는 `player_info_schema.py` 기준 `ItemBase[]`로 반환한다.
