# plan_0010 - Cypher/SQL End-to-End Verification Hardening

## User Requirements

- 위 기능들이 신뢰 가능하도록 프로젝트 내 모든 핵심 SQL/Cypher의 정상 동작을 검증해야 함.
- 목업 기반 검증은 `tests/`, 실제 연결 검증은 `scripts/`에서 수행해야 함.

## Goal

- 문법 검증을 넘어, 실제 API 시나리오 기준으로 SQL 트리거 + Cypher 쿼리 + 엔드포인트 계약을 통합 검증한다.

## Scope

- **In**:
  - `tests/`의 단위/통합 테스트 보강 (mock + testcontainers)
  - `scripts/verify_sql_syntax.py`와 `scripts/api_verification.py` 시나리오 확장
  - 신규 endpoint 계약(player, context, commit) 회귀 방지
- **Out**:
  - 부하 테스트/성능 벤치마크
  - 운영 모니터링 대시보드 구축

## Implementation Plan

- Step 1: 테스트 매트릭스 정리 (API contract / repository / cypher query / trigger)
- Step 2: `verify_sql_syntax.py`에 신규 cypher 파라미터와 commit 관련 쿼리 검증 추가
- Step 3: `api_verification.py`에 player schema 검증 + sequence context + commit 반영 검증 추가
- Step 4: CI에서 실행 순서 표준화 (`pytest` -> `verify_sql_syntax.py` -> `api_verification.py`)

## Unit Test Plan (must)

- **What to test**:
  - 신규 라우터 스키마 계약
  - 서비스 레이어 변경 파이프라인
  - Cypher 파일별 경계값(없음/중복/비활성)
- **Command**:
  - `uv run pytest tests/test_router_INQUIRY.py tests/test_router_COMMIT.py tests/test_context_relations.py tests/test_inventory_cypher.py tests/test_relation_cypher.py`

## E2E Plan (must)

- **How to run**:
  - `uv run python scripts/verify_sql_syntax.py`
  - `uv run python scripts/api_verification.py`
- **Validation**:
  - 실패 지점을 SQL/트리거/Cypher/API 레이어로 구분해서 로그 출력

## Done Criteria

- [x] 기능 경로별 테스트 매트릭스 문서화
- [x] `tests/` 신규/보강 테스트 통과
- [x] `scripts/` 실연결 검증 통과
- [x] 회귀 시 원인 레이어를 즉시 식별 가능
