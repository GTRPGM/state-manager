# plan_0009 - GM Commit from Rule Engine Result Schema

## User Requirements

- GM 커밋 엔드포인트가 `rule_engine_result_schema.py` 입력 구조를 받아 세계 상태를 업데이트해야 함.
- 업데이트 대상은 엔티티 변화(`diffs`)와 관계 변화(`relations`)를 모두 포함함.

## Goal

- `/state/commit`의 입력 모델을 Rule Engine 결과 스키마와 호환되게 확장하고, 서비스 레이어가 이를 graph/sql 업데이트로 안전하게 반영한다.

## Scope

- **In**:
  - `CommitRequest`에서 Rule Engine 스키마 내부 데이터(`diffs`, `relations`)를 래핑 수용
  - `router_COMMIT.py` 파싱 로직 교체(현재 ad-hoc diff 변환 제거)
  - `StateService.write_state_changes`에 관계 업데이트 경로 추가
  - 관계 Cypher(create/update/delete) 연결
- **Out**:
  - 분산 트랜잭션/사가 패턴 도입
  - Rule Engine 서비스 프로토콜 변경

## Implementation Plan

- Step 1: `rule_engine_result_schema.py`의 `PhaseUpdate(diffs, relations)`를 Commit 입력 규약으로 정식 채택
- Step 2: `router_COMMIT.py`에서 `turn_id`/session 파싱과 diff normalization 로직 정리
- Step 3: `StateService.write_state_changes`를 엔티티/관계 처리 파이프라인으로 분리
- Step 4: 관계 변경은 전용 Cypher 쿼리(`relation_create`, `relation_update`, `relation_deactivate`)로 일원화
- Step 5: 실패 케이스(존재하지 않는 엔티티, 세션 불일치)에서 명확한 4xx 응답 규칙 정의

## Unit Test Plan (must)

- **What to test**:
  - Rule Engine 형식 커밋 요청이 정상 반영되는지
  - relation 추가/수정/비활성화가 기대대로 적용되는지
  - 잘못된 entity id/type 입력 시 오류 처리되는지
- **Test cases**:
  - `tests/test_router_COMMIT.py` 신규
  - `tests/test_state_service_commit_pipeline.py` 신규
- **Command**:
  - `uv run pytest tests/test_router_COMMIT.py tests/test_state_service_commit_pipeline.py`

## E2E Plan (must)

- **Scenario**:
  - context 조회 -> Rule Engine 결과 형태 commit -> context 재조회로 반영 확인
- **How to run**:
  - `scripts/api_verification.py`에 `commit(rule_engine_payload)` 단계 추가

## Done Criteria

- [ ] `/state/commit`이 `rule_engine_result_schema.py` payload를 수용
- [ ] 엔티티/관계 변경이 함께 반영
- [ ] 오류 응답 규약(4xx/5xx) 정리 및 테스트 통과

## Fixed Decisions

- GM은 `rule_engine_result_schema.py`의 내부 데이터(`PhaseUpdate`)를 전달한다.
- 서버는 기존 `CommitRequest`에 해당 데이터를 래핑해 수용한다.
