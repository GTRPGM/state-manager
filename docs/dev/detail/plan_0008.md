# plan_0008 - GM Sequence Context Endpoint

## User Requirements

- GM이 시퀀스 단위로 세계 정보 스냅샷을 조회할 수 있어야 함.
- 조회 데이터는 Graph-first 원칙을 따르고, 필요한 범위만 제한적으로 반환해야 함.

## Goal

- `/state/session/{session_id}/context`를 시퀀스 스코프 조회로 확장(또는 별도 엔드포인트 추가)하고, 인벤토리/관계/엔티티를 동일 시점 기준으로 반환한다.

## Scope

- **In**:
  - `StateService.get_state_snapshot` 시퀀스 필터 입력 처리
  - `context.cypher` 조회 조건에 sequence/active 필터 반영
  - 기존 `/state/session/{session_id}/context` 엔드포인트에 query param 추가
- **Out**:
  - 장기 이력(턴 전체 리플레이) API 구현
  - 대용량 pagination 최적화

## Implementation Plan

- Step 1: 시퀀스 단위의 정확한 기준값(현재 시퀀스 번호 vs 시퀀스 ID) 확정
- Step 2: `src/state_db/Query/CYPHER/inquiry/context.cypher`를 sequence-aware 조회로 개편
- Step 3: `PlayerRepository.get_full_context`와 `StateService.get_state_snapshot`에 필터 파라미터 전달
- Step 4: `/state/session/{session_id}/context` 응답에 조회 기준(sequence 메타) 명시

## Unit Test Plan (must)

- **What to test**:
  - sequence 조건에 따라 조회 결과가 달라지는지
  - include_inactive 옵션/기본값이 일관적인지
- **Test cases**:
  - `tests/test_context_relations.py` 확장
  - `tests/test_state_snapshot_sequence_filter.py` 신규
- **Command**:
  - `uv run pytest tests/test_context_relations.py tests/test_state_snapshot_sequence_filter.py`

## E2E Plan (must)

- **Scenario**:
  - 세션 시작 -> 시퀀스 변경 -> 각 시퀀스에서 context 조회 -> 결과 비교
- **How to run**:
  - `scripts/api_verification.py`에 sequence-context 검증 단계 추가

## Done Criteria

- [x] GM context 조회가 시퀀스 기준으로 동작
- [x] context 응답에 sequence 기준 정보 포함
- [x] 단위 테스트 + 스크립트 검증 통과

## Fixed Decisions

- 시퀀스 단위 조회는 기존 `/state/session/{session_id}/context`에 query param 방식으로 추가한다.
