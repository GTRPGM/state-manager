# plan_0002 - EntityRepository Cypher Conversion

## Goal

- `EntityRepository`의 NPC 및 Enemy 관련 CRUD 로직을 SQL에서 Cypher로 완전히 전환합니다.

## Scope

- In: `src/state_db/repositories/entity.py`, `src/state_db/Query/CYPHER`
- Out: `src/state_db/Query/MANAGE` 내 관련 SQL

## Implementation Plan

- Step 1: NPC/Enemy 스폰(Spawn) 및 상태 변경 Cypher 쿼리 작성 (속성은 ID, Name, Active만 다룸)
- Step 2: `EntityRepository`의 `spawn_npc`, `spawn_enemy` 등을 `run_cypher`로 교체
- Step 3: 트리거 기반 동기화와 명시적 Cypher 조작 간의 일관성 검증 (상태 데이터는 SQL 조회 유지)
- Step 4: 레거시 스탯 조회 로직(그래프에서 스탯을 읽으려던 시도) 제거 및 SQL 기반으로 통합

## Unit Test Plan (must)

- What to test: NPC/Enemy 생성 및 속성(HP 등) 업데이트가 그래프에 반영되는지 확인
- Test cases: `tests/test_router_MANAGE.py` (Mock 또는 Testcontainers)
- Command:
  - uv run pytest tests

## E2E Plan (must)

- Scenario: NPC 스폰 API 호출 -> 그래프 조회로 노드 존재 확인 -> NPC 퇴장/복귀 처리
- Expected: AGE 그래프 상에서 노드의 `active` 상태가 변경됨
- How to run: `scripts/api_verification.py` 실행
- Validation: DB 직접 쿼리 및 API 응답 확인

## Done Criteria

- [x] implementation completed
- [x] unit tests added/updated and passing
- [ ] e2e executed and passing
- [x] docs updated if needed
